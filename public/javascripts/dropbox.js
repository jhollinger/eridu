function Dropbox(a,b){this.box=a;this.url=b;this.uploads=document.createElement("div");this.box.parentNode.insertBefore(this.uploads,this.box.nextSibling);this.max_size=null;this.success=null;this.error=null;var c=this;this.box.addEventListener("dragenter",function(a){c.drag(a,true)},false);this.box.addEventListener("dragleave",function(a){c.drag(a,false)},false);this.box.addEventListener("dragover",noop,false);this.box.addEventListener("drop",function(a){c.drop(a)},false)}function noop(a){a.stopPropagation();a.preventDefault()}Dropbox.prototype.handle_file=function(a){if(this.max_size&&a.size/1024/1024>this.max_size){alert(a.name+" is too large; maximum allowed size is "+this.max_size.toFixed(2)+" MB")}else{var b=this;var c=this.add_label(a);var d=new FileReader;d.onload=function(d){var e=d.target.result.split(",")[1];b.upload_file(a,e,c)};d.readAsDataURL(a)}};Dropbox.prototype.upload_file=function(a,b,c){c.getElementsByTagName("span")[0].innerHTML="Uploading";var d=new FormData;d.append("filename",a.name);d.append("mimetype",a.type);d.append("data",b);d.append("size",a.size);var e=this;var f=new XMLHttpRequest;if(f.upload)f.upload.addEventListener("progress",function(a){e.handle_upload_progress(a,c)},false);f.open("POST",this.url);f.onreadystatechange=function(b){if(f.readyState===4){if(f.status===200){c.getElementsByTagName("span")[0].innerHTML="Completed uploading";if(e.success)e.success(a,f.responseText)}else{c.getElementsByTagName("span")[0].innerHTML="Error while uploading";if(e.error)e.error(a,f.statusText)}setTimeout(function(){e.uploads.removeChild(c)},1e3)}};f.send(d)};Dropbox.prototype.handle_upload_progress=function(a,b){if(a.lengthComputable){var c=b.getElementsByTagName("progress")[0];c.setAttribute("value",a.loaded);c.setAttribute("max",a.total)}};Dropbox.prototype.add_label=function(a){var b=(a.size/1024/1024).toFixed(2);var c=document.createElement("div");c.innerHTML="<progress></progress> <span>Processing</span> "+a.name+" ("+b+" MB)";this.uploads.insertBefore(c,null);return c};Dropbox.prototype.drag=function(a,b){noop(a);this.box.className=b?this.box.className+=" active":this.box.className.replace(/ ?active/,"")};Dropbox.prototype.drop=function(a){this.drag(a,false);var b=a.dataTransfer.files;for(var c=0;c<b.length;c++)this.handle_file(b[c])}
